# Queue Pipeline Architecture

## Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TaskFlow Queue Pipeline                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚   Upload    â”‚
â”‚     PDF     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /upload (multipart/form-data)
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PDF SERVICE                                  â”‚
â”‚  â€¢ Uploads to Supabase Storage                                      â”‚
â”‚  â€¢ Saves File metadata to DB                                        â”‚
â”‚  â€¢ Returns: fileId, url, jobId                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Triggers PDF Extract Queue
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUEUE 1: PDF-EXTRACT                             â”‚
â”‚  Redis: pdf-extract queue                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WORKER 1: PDF Extract Worker                       â”‚
â”‚                                                                      â”‚
â”‚  Step 1: Download PDF from Supabase        [Progress: 10%]         â”‚
â”‚  Step 2: Extract text with pdf-parse       [Progress: 50%]         â”‚
â”‚  Step 3: Clean extracted text              [Progress: 70%]         â”‚
â”‚  Step 4: Save to DB as Note                [Progress: 85%]         â”‚
â”‚  Step 5: Queue AI Notes job                [Progress: 95%]         â”‚
â”‚  Step 6: Complete                          [Progress: 100%]        â”‚
â”‚                                                                      â”‚
â”‚  Output: Extracted text saved in Database                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Automatically triggers AI Notes Queue
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     QUEUE 2: AI-NOTES                               â”‚
â”‚  Redis: ai-notes queue                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WORKER 2: AI Notes Worker                          â”‚
â”‚                                                                      â”‚
â”‚  Step 1: Validate text length              [Progress: 10%]         â”‚
â”‚  Step 2: Call Gemini AI API                [Progress: 30%]         â”‚
â”‚          â€¢ Create structured prompt                                 â”‚
â”‚          â€¢ Generate organized notes                                 â”‚
â”‚          â€¢ Format with headings & emojis   [Progress: 70%]         â”‚
â”‚  Step 3: Save notes to DB                  [Progress: 85%]         â”‚
â”‚  Step 4: Queue AI Quiz job                 [Progress: 95%]         â”‚
â”‚  Step 5: Complete                          [Progress: 100%]        â”‚
â”‚                                                                      â”‚
â”‚  Output: Structured study notes in Database                         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Automatically triggers AI Quiz Queue
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     QUEUE 3: AI-QUIZ                                â”‚
â”‚  Redis: ai-quiz queue                                               â”‚
â”‚  Status: âœ… Queue created, Worker TODO                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WORKER 3: AI Quiz Worker (TODO)                    â”‚
â”‚                                                                      â”‚
â”‚  Step 1: Validate note content             [Progress: 10%]         â”‚
â”‚  Step 2: Call Gemini AI API                [Progress: 30%]         â”‚
â”‚          â€¢ Generate quiz questions                                  â”‚
â”‚          â€¢ Multiple choice format                                   â”‚
â”‚          â€¢ Include explanations            [Progress: 70%]         â”‚
â”‚  Step 3: Save quiz to DB                   [Progress: 90%]         â”‚
â”‚  Step 4: Queue completion job              [Progress: 95%]         â”‚
â”‚  Step 5: Complete                          [Progress: 100%]        â”‚
â”‚                                                                      â”‚
â”‚  Output: Quiz questions in Database                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  QUEUE 4: COMPLETION (TODO)                         â”‚
â”‚  Redis: completion queue                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                WORKER 4: Completion Worker (TODO)                   â”‚
â”‚                                                                      â”‚
â”‚  â€¢ Send WebSocket notification to user                              â”‚
â”‚  â€¢ Update final job status                                          â”‚
â”‚  â€¢ Trigger any cleanup tasks                                        â”‚
â”‚                                                                      â”‚
â”‚  Output: User notified, pipeline complete                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Done! â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Tables Involved

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      File       â”‚     â”‚      Note       â”‚     â”‚      Quiz       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â”€â”€â”€â”€>â”‚ source (FK)     â”‚â”€â”€â”€â”€>â”‚ noteId (FK)     â”‚
â”‚ url             â”‚     â”‚ id (PK)         â”‚     â”‚ id (PK)         â”‚
â”‚ name            â”‚     â”‚ title           â”‚     â”‚ title           â”‚
â”‚ userId (FK)     â”‚     â”‚ content         â”‚     â”‚ questions (JSON)â”‚
â”‚ createdAt       â”‚     â”‚ userId (FK)     â”‚     â”‚ userId (FK)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ createdAt       â”‚     â”‚ createdAt       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      Job        â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ id (PK)         â”‚
                        â”‚ jobId (unique)  â”‚
                        â”‚ name            â”‚
                        â”‚ queueName       â”‚
                        â”‚ status          â”‚
                        â”‚ progress        â”‚
                        â”‚ data (JSON)     â”‚
                        â”‚ userId (FK)     â”‚
                        â”‚ createdAt       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Redis Queues Structure

```
Redis (Upstash)
â”œâ”€â”€ pdf-extract
â”‚   â”œâ”€â”€ waiting: [job:1, job:5, ...]
â”‚   â”œâ”€â”€ active: [job:3]
â”‚   â”œâ”€â”€ completed: [job:2, job:4, ...]
â”‚   â””â”€â”€ failed: [job:6]
â”‚
â”œâ”€â”€ ai-notes
â”‚   â”œâ”€â”€ waiting: [job:7, job:11, ...]
â”‚   â”œâ”€â”€ active: [job:9]
â”‚   â”œâ”€â”€ completed: [job:8, job:10, ...]
â”‚   â””â”€â”€ failed: []
â”‚
â”œâ”€â”€ ai-quiz
â”‚   â”œâ”€â”€ waiting: [job:12, ...]
â”‚   â”œâ”€â”€ active: [job:13]
â”‚   â”œâ”€â”€ completed: [job:14, ...]
â”‚   â””â”€â”€ failed: []
â”‚
â””â”€â”€ completion
    â”œâ”€â”€ waiting: []
    â”œâ”€â”€ active: []
    â”œâ”€â”€ completed: [job:15, ...]
    â””â”€â”€ failed: []
```

## Job State Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WAITING â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Initial state
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Worker picks up job
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACTIVE â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Processing
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”
     â”‚    â”‚
     â”‚    â”‚ Error occurs
     â”‚    v
     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ â”‚ FAILED â”‚ â”€â”€â”€> Retry? â”€â”€â”€> Back to WAITING
     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                  â”‚ Max attempts reached
     â”‚                  v
     â”‚              Permanent failure
     â”‚
     â”‚ Success
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETED â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Done!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Progress Tracking

Each job reports granular progress:

```
PDF Extract Worker:
0%   â†’ Job started
10%  â†’ PDF downloaded
50%  â†’ Text extracted
70%  â†’ Text cleaned
85%  â†’ Saved to database
95%  â†’ Next job queued
100% â†’ Complete

AI Notes Worker:
0%   â†’ Job started
10%  â†’ Text validated
30%  â†’ Gemini API called
70%  â†’ Notes generated
85%  â†’ Saved to database
95%  â†’ Quiz job queued
100% â†’ Complete

AI Quiz Worker:
0%   â†’ Job started
10%  â†’ Note content validated
30%  â†’ Gemini API called
70%  â†’ Quiz generated
90%  â†’ Saved to database
95%  â†’ Completion job queued
100% â†’ Complete
```

## API Endpoints

```
Upload & Jobs:
POST   /upload                    â†’ Upload PDF, start pipeline
GET    /jobs/:jobId               â†’ Get specific job status
GET    /jobs/user/:userId         â†’ Get user's jobs
GET    /jobs/queue/:queueName     â†’ Get queue jobs
DELETE /jobs/cleanup?days=7       â†’ Clean old jobs

Content Access:
GET    /notes/user/:userId        â†’ Get user's notes
GET    /notes/:noteId/user/:userId â†’ Get specific note
GET    /quizzes/user/:userId      â†’ Get user's quizzes
GET    /quizzes/:quizId/user/:userId â†’ Get specific quiz
```

## Status: Current Implementation

âœ… **Completed:**
- Queue 1: PDF Extract (Worker âœ…)
- Queue 2: AI Notes (Worker âœ…)
- Queue 3: AI Quiz (Queue âœ…, Worker â³)

â³ **TODO:**
- Queue 3: AI Quiz Worker implementation
- Queue 4: Completion Queue & Worker
- WebSocket real-time notifications

**Pipeline Progress: 66% Complete** ğŸ‰
